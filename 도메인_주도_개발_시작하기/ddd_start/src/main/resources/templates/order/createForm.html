<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Create Order</title>

    <script>
        let productIndex = 1;

        function addProduct() {
            const container = document.getElementById("orderProducts");
            const template = document.getElementById("productTemplate").innerHTML;

            // __index__ 를 현재 인덱스로 교체
            const newProductForm = template.replace(/__index__/g, productIndex);
            const wrapper = document.createElement("div");
            wrapper.classList.add("order-product");
            wrapper.innerHTML = newProductForm;

            container.appendChild(wrapper);
            productIndex++;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("orderForm");

            form.addEventListener("submit", function (e) {
                e.preventDefault(); // 기본 form 제출 막기

                // orderProducts 수집
                const orderProducts = [];
                document.querySelectorAll(".order-product").forEach((productDiv, idx) => {
                    const productId = productDiv.querySelector("select").value;
                    const quantity = productDiv.querySelector("input[type='number']").value;
                    orderProducts.push({productId, quantity: parseInt(quantity)});
                });

                // ordererMemberId
                const ordererMemberId = document.getElementById("ordererMemberId").value;

                // shippingInfo 수집
                const receiverName = document.getElementById("receiverName").value;
                const receiverPhone = document.getElementById("receiverPhone").value;
                const message = document.getElementById("message").value;
                const address1 = document.getElementById("address1").value;
                const address2 = document.getElementById("address2").value;
                const zipCode = document.getElementById("zipCode").value;

                // 최종 JSON 요청 본문
                const payload = {
                    orderProducts,
                    ordererMemberId,
                    receiverName,
                    receiverPhone,
                    message,
                    address1,
                    address2,
                    zipCode
                };

                fetch("/order/place", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        if (response.ok) {
                            alert("주문이 성공적으로 생성되었습니다!");
                            window.location.href = "/orders"; // 필요시 리다이렉트
                        } else {
                            alert("주문 생성 실패!");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("서버 오류가 발생했습니다.");
                    });
            });
        });
    </script>
</head>
<body>
<h1>Order Create Form</h1>
<form id="orderForm">
    <label for="orderProducts">Order Products:</label>
    <div id="orderProducts">
        <!-- 기본 하나는 표시 -->
        <div class="order-product">
            <label>Product:</label>
            <select name="orderProducts[0].productId" required>
                <option value="">-- Select Product --</option>
                <th:block th:each="product : ${products}">
                    <option th:value="${product.productId}"
                            th:text="${product.productName}"></option>
                </th:block>
            </select>
            <br>

            <label>Quantity:</label>
            <input type="number" name="orderProducts[0].quantity" min="1" required>
            <br><br>
        </div>
    </div>
    <button type="button" onclick="addProduct()">➕ Add Product</button>
    <br><br>

    <label for="ordererMemberId">Orderer Member ID:</label>
    <input type="hidden" id="ordererMemberId" name="ordererMemberId" th:value="${ordererMemberId}">
    <br>

    <label for="shippingInfo">Shipping Info</label>
    <br>
    <div id="shippingInfo">
        <label for="receiverName">Receiver Name:</label>
        <input type="text" id="receiverName" name="receiverName" th:value="${receiverName}" required>
        <br>

        <label for="receiverPhone">Receiver Phone:</label>
        <input type="text" id="receiverPhone" name="receiverPhone" required>
        <br>

        <label for="message">Message:</label>
        <input type="text" id="message" name="message">
        <br>

        <label for="address1">Address Line 1:</label>
        <input type="text" id="address1" name="address1" th:value="${address1}" required>
        <br>

        <label for="address2">Address Line 2:</label>
        <input type="text" id="address2" name="address2" th:value="${address2}">
        <br>

        <label for="zipCode">ZipCode:</label>
        <input type="text" id="zipCode" name="zipCode" th:value="${zipCode}" required>
    </div>
    <br>

    <button type="submit">Create Order</button>
</form>

<!-- 제품 선택 및 수량 입력 폼 템플릿 (숨김) -->
<div id="productTemplate" style="display:none;">
    <label>Product:</label>
    <select name="orderProducts[__index__].productId" required>
        <option value="">-- Select Product --</option>
        <th:block th:each="product : ${products}">
            <option th:value="${product.productId}"
                    th:text="${product.productName}"></option>
        </th:block>
    </select>
    <br>
    <label>Quantity:</label>
    <input type="number" name="orderProducts[__index__].quantity" min="1" required>
    <br><br>
</div>
</body>
</html>
